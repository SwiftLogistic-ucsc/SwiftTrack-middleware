<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SwiftTrack - Swift Logistics Order Portal</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }
      .form-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .form-section h3 {
        margin-top: 0;
        color: #34495e;
      }
      label {
        display: block;
        margin: 10px 0 5px;
        font-weight: bold;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background: #3498db;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #2980b9;
      }
      .feed {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
      }
      .feed li {
        margin: 5px 0;
        padding: 8px;
        border-left: 4px solid #3498db;
        background: white;
        border-radius: 3px;
      }
      .feed li.error {
        border-left-color: #e74c3c;
        background: #fdf2f2;
      }
      .feed li.success {
        border-left-color: #27ae60;
        background: #f2f8f2;
      }
      .add-button {
        background: #27ae60;
        margin: 5px 0;
        padding: 5px 10px;
        font-size: 12px;
      }
      .remove-button {
        background: #e74c3c;
        margin-left: 10px;
        padding: 2px 8px;
        font-size: 12px;
      }
      .package-item,
      .address-item {
        border: 1px solid #eee;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
        background: #fafafa;
      }
      .order-search {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
      }
      .order-details {
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 10px 0;
        padding: 15px;
      }
      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status-submitted {
        background: #e3f2fd;
        color: #1976d2;
      }
      .status-cms_verified {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .status-wms_registered {
        background: #fff3e0;
        color: #f57c00;
      }
      .status-ros_optimized {
        background: #e8f5e8;
        color: #388e3c;
      }
      .status-ready_for_delivery {
        background: #e1f5fe;
        color: #0277bd;
      }
      .status-out_for_delivery {
        background: #fff8e1;
        color: #f9a825;
      }
      .status-delivered {
        background: #e8f5e8;
        color: #2e7d32;
      }
      .status-failed {
        background: #ffebee;
        color: #c62828;
      }
      .order-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 10px 0;
      }
      .info-group {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
      }
      .info-label {
        font-weight: bold;
        color: #495057;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 5px;
      }
      .info-value {
        color: #212529;
      }
      .packages-list {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        margin: 10px 0;
      }
      .package-detail {
        background: white;
        padding: 8px;
        margin: 5px 0;
        border-radius: 3px;
        border-left: 3px solid #3498db;
      }
      .search-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .search-input {
        flex: 1;
        min-width: 200px;
      }
      .orders-list {
        max-height: 600px;
        overflow-y: auto;
      }
      .loading {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 20px;
      }
      .no-orders {
        text-align: center;
        color: #6c757d;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 5px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>SwiftTrack ‚Äî Swift Logistics E-Commerce Portal</h2>

      <form id="orderForm">
        <div class="form-section">
          <h3>Order Information</h3>
          <label
            >Order ID:
            <input id="orderId" required placeholder="e.g., ORD-2025-001"
          /></label>
          <label
            >Client ID:
            <input
              id="clientId"
              value="client-123"
              required
              placeholder="e.g., CLIENT-001"
          /></label>
          <label
            >Priority:
            <select id="priority">
              <option value="STANDARD">Standard</option>
              <option value="URGENT">Urgent</option>
            </select>
          </label>
        </div>

        <div class="form-section">
          <h3>Packages</h3>
          <div id="packages">
            <div class="package-item">
              <label
                >SKU:
                <input name="packageSku" required placeholder="e.g., BOOK-001"
              /></label>
              <label
                >Description:
                <input name="packageDesc" placeholder="e.g., Programming Book"
              /></label>
              <label
                >Quantity:
                <input name="packageQty" type="number" value="1" min="1"
              /></label>
              <label
                >Priority:
                <select name="packagePriority">
                  <option value="STANDARD">Standard</option>
                  <option value="URGENT">Urgent</option>
                </select>
              </label>
            </div>
          </div>
          <button type="button" class="add-button" onclick="addPackage()">
            + Add Package
          </button>
        </div>

        <div class="form-section">
          <h3>Delivery Addresses</h3>
          <div id="addresses">
            <div class="address-item">
              <textarea
                name="deliveryAddress"
                required
                placeholder="e.g., No 123, Main Street, Colombo 07"
              ></textarea>
            </div>
          </div>
          <button type="button" class="add-button" onclick="addAddress()">
            + Add Address
          </button>
        </div>

        <button type="submit">Submit Order to Swift Logistics</button>
      </form>

      <!-- Order Search and History Section -->
      <div class="form-section">
        <h3>üìã Order History & Tracking</h3>
        <div class="order-search">
          <div class="search-controls">
            <input
              type="text"
              id="searchOrderId"
              placeholder="Search by Order ID (e.g., ORD-POSTMAN-001)"
              class="search-input"
            />
            <button type="button" onclick="searchOrder()">
              üîç Search Order
            </button>
            <button type="button" onclick="loadAllOrders()">
              üìÑ Load All Orders
            </button>
            <button type="button" onclick="clearOrderHistory()">
              üóëÔ∏è Clear
            </button>
          </div>
        </div>

        <div id="orderHistorySection">
          <div id="orderResults" class="orders-list"></div>
        </div>
      </div>

      <h3>üì° Live Order Tracking</h3>
      <ul id="feed" class="feed"></ul>
    </div>

    <script>
      // Real-time updates via WebSocket
      const socket = io("http://localhost:3002");
      socket.on("orderUpdate", (evt) => {
        const li = document.createElement("li");
        const eventClass = evt.eventType.includes("FAILED")
          ? "error"
          : "success";
        li.className = eventClass;

        let message = `[${evt.timestamp}] ${evt.eventType} ‚Äî Order ${evt.orderId}`;

        // Add additional details based on event type
        if (evt.data && evt.data.assignedDriver) {
          message += ` (Driver: ${evt.data.assignedDriver})`;
        }
        if (evt.data && evt.data.etaMinutes) {
          message += ` (ETA: ${evt.data.etaMinutes} minutes)`;
        }
        if (evt.data && evt.data.contractId) {
          message += ` (Contract: ${evt.data.contractId})`;
        }
        if (evt.data && evt.data.error) {
          message += ` (Error: ${evt.data.error})`;
        }

        li.textContent = message;
        document.getElementById("feed").prepend(li);
      });

      // Add package function
      function addPackage() {
        const packagesDiv = document.getElementById("packages");
        const packageItem = document.createElement("div");
        packageItem.className = "package-item";
        packageItem.innerHTML = `
          <label>SKU: <input name="packageSku" required placeholder="e.g., ELECTRONICS-001" /></label>
          <label>Description: <input name="packageDesc" placeholder="e.g., Smartphone" /></label>
          <label>Quantity: <input name="packageQty" type="number" value="1" min="1" /></label>
          <label>Priority: 
            <select name="packagePriority">
              <option value="STANDARD">Standard</option>
              <option value="URGENT">Urgent</option>
            </select>
          </label>
          <button type="button" class="remove-button" onclick="this.parentElement.remove()">Remove</button>
        `;
        packagesDiv.appendChild(packageItem);
      }

      // Add address function
      function addAddress() {
        const addressesDiv = document.getElementById("addresses");
        const addressItem = document.createElement("div");
        addressItem.className = "address-item";
        addressItem.innerHTML = `
          <textarea name="deliveryAddress" required placeholder="e.g., No 456, Galle Road, Colombo 03"></textarea>
          <button type="button" class="remove-button" onclick="this.parentElement.remove()">Remove</button>
        `;
        addressesDiv.appendChild(addressItem);
      }

      // Submit order form
      document
        .getElementById("orderForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Collect form data
          const orderId = document.getElementById("orderId").value;
          const clientId = document.getElementById("clientId").value;
          const priority = document.getElementById("priority").value;

          // Collect packages
          const packages = Array.from(
            document.querySelectorAll(".package-item")
          ).map((item) => ({
            sku: item.querySelector('input[name="packageSku"]').value,
            description: item.querySelector('input[name="packageDesc"]').value,
            quantity:
              parseInt(item.querySelector('input[name="packageQty"]').value) ||
              1,
            priority: item.querySelector('select[name="packagePriority"]')
              .value,
          }));

          // Collect delivery addresses
          const deliveryAddresses = Array.from(
            document.querySelectorAll('textarea[name="deliveryAddress"]')
          )
            .map((textarea) => textarea.value.trim())
            .filter((addr) => addr.length > 0);

          const orderData = {
            id: orderId,
            clientId,
            priority,
            packages,
            deliveryAddresses,
          };

          try {
            const response = await fetch("http://localhost:4000/api/orders", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(orderData),
            });

            const result = await response.json();

            if (response.ok) {
              alert(
                `Order submitted successfully! Order ID: ${result.orderId}`
              );
              document.getElementById("orderForm").reset();

              // Auto-search for the newly created order
              setTimeout(() => {
                document.getElementById("searchOrderId").value = result.orderId;
                searchOrder();
              }, 1000);
            } else {
              alert(
                `Order submission failed: ${result.error || result.message}`
              );
            }
          } catch (error) {
            alert(`Error submitting order: ${error.message}`);
          }
        });

      // Order search and history functions
      async function searchOrder() {
        const orderId = document.getElementById("searchOrderId").value.trim();
        if (!orderId) {
          alert("Please enter an Order ID to search");
          return;
        }

        showLoading();
        try {
          const response = await fetch(
            `http://localhost:4000/api/orders/${orderId}`
          );
          const result = await response.json();

          if (response.ok && result.order) {
            displayOrders([result.order]);
          } else {
            showNoOrdersMessage(`Order "${orderId}" not found`);
          }
        } catch (error) {
          showNoOrdersMessage(`Error searching for order: ${error.message}`);
        }
      }

      async function loadAllOrders() {
        showLoading();
        try {
          const response = await fetch("http://localhost:4000/api/orders");
          const result = await response.json();

          if (response.ok && result.orders && result.orders.length > 0) {
            displayOrders(result.orders);
          } else {
            showNoOrdersMessage("No orders found");
          }
        } catch (error) {
          showNoOrdersMessage(`Error loading orders: ${error.message}`);
        }
      }

      function displayOrders(orders) {
        const resultsDiv = document.getElementById("orderResults");
        resultsDiv.innerHTML = orders
          .map((order) => createOrderCard(order))
          .join("");
      }

      function createOrderCard(order) {
        const statusClass = `status-${order.status
          .toLowerCase()
          .replace(/_/g, "_")}`;
        const createdDate = new Date(
          order.submittedAt || order.created_at
        ).toLocaleString();

        return `
          <div class="order-details">
            <div class="order-header">
              <h4>Order ${order.id}</h4>
              <span class="status-badge ${statusClass}">${order.status.replace(
          /_/g,
          " "
        )}</span>
            </div>
            
            <div class="order-info">
              <div class="info-group">
                <div class="info-label">Client</div>
                <div class="info-value">${
                  order.clientName || order.clientId
                }</div>
              </div>
              <div class="info-group">
                <div class="info-label">Priority</div>
                <div class="info-value">${order.priority}</div>
              </div>
              <div class="info-group">
                <div class="info-label">Created</div>
                <div class="info-value">${createdDate}</div>
              </div>
              <div class="info-group">
                <div class="info-label">Driver</div>
                <div class="info-value">${
                  order.assignedDriver || "Not assigned"
                }</div>
              </div>
            </div>

            ${
              order.packages && order.packages.length > 0
                ? `
              <div class="packages-list">
                <div class="info-label">Packages (${
                  order.packages.length
                })</div>
                ${order.packages
                  .map(
                    (pkg) => `
                  <div class="package-detail">
                    <strong>${pkg.sku}</strong> - ${
                      pkg.description || "No description"
                    }
                    <br><small>Qty: ${pkg.quantity} | Priority: ${
                      pkg.priority
                    } | Weight: ${pkg.weight_kg || "N/A"}kg</small>
                  </div>
                `
                  )
                  .join("")}
              </div>
            `
                : ""
            }

            ${
              order.deliveryAddresses && order.deliveryAddresses.length > 0
                ? `
              <div class="info-group">
                <div class="info-label">Delivery Addresses</div>
                <div class="info-value">
                  ${
                    Array.isArray(order.deliveryAddresses)
                      ? order.deliveryAddresses.join("<br>")
                      : order.deliveryAddresses
                  }
                </div>
              </div>
            `
                : ""
            }

            ${
              order.estimatedDelivery
                ? `
              <div class="info-group">
                <div class="info-label">Estimated Delivery</div>
                <div class="info-value">${new Date(
                  order.estimatedDelivery
                ).toLocaleString()}</div>
              </div>
            `
                : ""
            }

            ${
              order.routeId
                ? `
              <div class="info-group">
                <div class="info-label">Route ID</div>
                <div class="info-value">${order.routeId}</div>
              </div>
            `
                : ""
            }
          </div>
        `;
      }

      function showLoading() {
        document.getElementById("orderResults").innerHTML =
          '<div class="loading">üîÑ Loading orders...</div>';
      }

      function showNoOrdersMessage(message) {
        document.getElementById(
          "orderResults"
        ).innerHTML = `<div class="no-orders">üìã ${message}</div>`;
      }

      function clearOrderHistory() {
        document.getElementById("orderResults").innerHTML = "";
        document.getElementById("searchOrderId").value = "";
      }

      // Enhanced real-time tracking with order refresh
      function refreshOrderInHistory(orderId) {
        const orderCards = document.querySelectorAll(".order-details h4");
        for (let card of orderCards) {
          if (card.textContent.includes(orderId)) {
            // Refresh this specific order
            searchOrder();
            break;
          }
        }
      }

      // Allow Enter key to search
      document
        .getElementById("searchOrderId")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            searchOrder();
          }
        });
    </script>
  </body>
</html>
