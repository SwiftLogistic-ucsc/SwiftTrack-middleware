<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SwiftTrack Driver Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .driver-info {
        display: flex;
        gap: 20px;
        align-items: center;
        color: #666;
      }

      .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-active {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #333;
        margin-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
      }

      .manifest-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .manifest-item h3 {
        color: #333;
        margin-bottom: 8px;
      }

      .manifest-item p {
        color: #666;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .delivery-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-warning {
        background: #ffc107;
        color: #333;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .updates-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .update-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: between;
        align-items: center;
      }

      .update-high {
        border-left: 4px solid #dc3545;
      }

      .update-medium {
        border-left: 4px solid #ffc107;
      }

      .upload-section {
        grid-column: 1 / -1;
      }

      .upload-form {
        display: flex;
        gap: 20px;
        align-items: end;
      }

      .form-group {
        flex: 1;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: bold;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 20px;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .connected {
        background: #28a745;
      }

      .disconnected {
        background: #dc3545;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .driver-info {
          flex-direction: column;
          align-items: start;
        }

        .upload-form {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <div class="container">
      <div class="header">
        <h1>SwiftTrack Driver Dashboard</h1>
        <div class="driver-info">
          <span>Driver: <strong id="driverName">Kasun Perera</strong></span>
          <span>Vehicle: <strong id="vehiclePlate">CAR-1234</strong></span>
          <span class="status-badge status-active">ACTIVE</span>
          <span>Route: <strong id="routeId">Loading...</strong></span>
        </div>
      </div>

      <div class="main-content">
        <!-- Delivery Manifest -->
        <div class="card">
          <h2>üìã Today's Delivery Manifest</h2>
          <div id="manifestContainer">
            <p>Loading manifest...</p>
          </div>
        </div>

        <!-- Real-time Updates -->
        <div class="card">
          <h2>‚ö° Real-time Updates</h2>
          <div class="updates-list" id="updatesList">
            <p>Waiting for updates...</p>
          </div>
        </div>

        <!-- Proof of Delivery Upload -->
        <div class="card upload-section">
          <h2>üì∏ Proof of Delivery</h2>
          <form id="proofForm" enctype="multipart/form-data">
            <div class="upload-form">
              <div class="form-group">
                <label for="packageSelect">Package:</label>
                <select id="packageSelect" required>
                  <option value="">Select package...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="customerName">Customer Name:</label>
                <input
                  type="text"
                  id="customerName"
                  placeholder="Enter customer name"
                />
              </div>
              <div class="form-group">
                <label for="deliveryPhoto">Delivery Photo:</label>
                <input
                  type="file"
                  id="deliveryPhoto"
                  name="photo"
                  accept="image/*"
                  multiple
                />
              </div>
              <div class="form-group">
                <label for="signature">Digital Signature:</label>
                <input
                  type="file"
                  id="signature"
                  name="signature"
                  accept="image/*"
                />
              </div>
              <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea
                  id="notes"
                  placeholder="Any delivery notes..."
                ></textarea>
              </div>
              <div class="form-group">
                <button type="submit" class="btn btn-success">
                  Upload Proof
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const DRIVER_ID = "DRV-001"; // In production, this would come from authentication
      const socket = io();

      let currentManifest = null;

      // Initialize WebSocket connection
      socket.on("connect", () => {
        console.log("Connected to driver service");
        updateConnectionStatus(true);

        // Join driver-specific room
        socket.emit("driver-login", { driverId: DRIVER_ID });
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from driver service");
        updateConnectionStatus(false);
      });

      socket.on("connection-confirmed", (data) => {
        console.log("Driver login confirmed:", data.message);
        // Load initial data
        loadManifest();
        loadRouteUpdates();
      });

      // Real-time event handlers
      socket.on("delivery-status-update", (data) => {
        console.log("Delivery status updated:", data);
        addUpdateToList(
          `Package ${data.packageId} status: ${data.status}`,
          "medium"
        );
        loadManifest(); // Refresh manifest
      });

      socket.on("proof-of-delivery-uploaded", (data) => {
        console.log("Proof of delivery uploaded:", data);
        addUpdateToList(
          `Proof uploaded for package ${data.packageId}`,
          "medium"
        );
      });

      socket.on("route-update", (data) => {
        console.log("Route updated:", data);
        addUpdateToList(data.message, data.severity);
      });

      // Load delivery manifest
      async function loadManifest() {
        try {
          const response = await fetch(`/api/drivers/${DRIVER_ID}/manifest`);
          const data = await response.json();

          if (data.ok) {
            currentManifest = data.manifest;
            displayManifest(data.manifest);
            updatePackageSelect(data.manifest.optimizedRoute);
            document.getElementById("routeId").textContent =
              data.manifest.routeId;
          }
        } catch (error) {
          console.error("Failed to load manifest:", error);
        }
      }

      // Display manifest in UI
      function displayManifest(manifest) {
        const container = document.getElementById("manifestContainer");

        if (!manifest.optimizedRoute || manifest.optimizedRoute.length === 0) {
          container.innerHTML = "<p>No deliveries assigned for today.</p>";
          return;
        }

        container.innerHTML = manifest.optimizedRoute
          .map(
            (stop) => `
                <div class="manifest-item">
                    <h3>Stop ${stop.stopId}: ${stop.customerName}</h3>
                    <p><strong>Address:</strong> ${stop.address}</p>
                    <p><strong>Package:</strong> ${
                      stop.packageDetails.description
                    } (${stop.packageDetails.sku})</p>
                    <p><strong>Time Window:</strong> ${
                      stop.timeWindow.earliest
                    } - ${stop.timeWindow.latest}</p>
                    <p><strong>Status:</strong> ${
                      stop.currentStatus?.status || "PENDING"
                    }</p>
                    ${
                      stop.specialInstructions
                        ? `<p><strong>Instructions:</strong> ${stop.specialInstructions}</p>`
                        : ""
                    }
                    <div class="delivery-actions">
                        <button class="btn btn-success" onclick="updateDeliveryStatus('${
                          stop.packageId
                        }', 'DELIVERED')">
                            ‚úÖ Delivered
                        </button>
                        <button class="btn btn-danger" onclick="updateDeliveryStatus('${
                          stop.packageId
                        }', 'FAILED')">
                            ‚ùå Failed
                        </button>
                        <button class="btn btn-warning" onclick="updateDeliveryStatus('${
                          stop.packageId
                        }', 'ATTEMPTED')">
                            üîÑ Attempt
                        </button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // Update package select dropdown
      function updatePackageSelect(route) {
        const select = document.getElementById("packageSelect");
        select.innerHTML =
          '<option value="">Select package...</option>' +
          route
            .map(
              (stop) =>
                `<option value="${stop.packageId}">${stop.packageId} - ${stop.customerName}</option>`
            )
            .join("");
      }

      // Update delivery status
      async function updateDeliveryStatus(packageId, status) {
        const reason =
          status === "FAILED" ? prompt("Reason for failure:") : null;

        try {
          const response = await fetch(
            `/api/drivers/${DRIVER_ID}/deliveries/${packageId}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                status,
                reason,
                timestamp: new Date().toISOString(),
              }),
            }
          );

          const data = await response.json();
          if (data.ok) {
            addUpdateToList(
              `Package ${packageId} marked as ${status}`,
              "medium"
            );
            loadManifest(); // Refresh manifest
          } else {
            alert("Failed to update status: " + data.error);
          }
        } catch (error) {
          console.error("Failed to update delivery status:", error);
          alert("Failed to update status");
        }
      }

      // Load route updates
      async function loadRouteUpdates() {
        try {
          const response = await fetch(
            `/api/drivers/${DRIVER_ID}/route-updates`
          );
          const data = await response.json();

          if (data.ok && data.routeUpdates.updates) {
            data.routeUpdates.updates.forEach((update) => {
              addUpdateToList(update.message, update.severity);
            });
          }
        } catch (error) {
          console.error("Failed to load route updates:", error);
        }
      }

      // Add update to real-time updates list
      function addUpdateToList(message, severity) {
        const list = document.getElementById("updatesList");
        const item = document.createElement("div");
        item.className = `update-item update-${severity.toLowerCase()}`;
        item.innerHTML = `
                <div>
                    <strong>${new Date().toLocaleTimeString()}</strong><br>
                    ${message}
                </div>
            `;

        if (list.firstChild?.textContent.includes("Waiting for updates")) {
          list.innerHTML = "";
        }

        list.insertBefore(item, list.firstChild);

        // Keep only last 10 updates
        while (list.children.length > 10) {
          list.removeChild(list.lastChild);
        }
      }

      // Handle proof of delivery form
      document
        .getElementById("proofForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const packageId = document.getElementById("packageSelect").value;
          if (!packageId) {
            alert("Please select a package");
            return;
          }

          const formData = new FormData();
          formData.append(
            "customerName",
            document.getElementById("customerName").value
          );
          formData.append("notes", document.getElementById("notes").value);

          const photoFiles = document.getElementById("deliveryPhoto").files;
          for (let i = 0; i < photoFiles.length; i++) {
            formData.append("photo", photoFiles[i]);
          }

          const signatureFile = document.getElementById("signature").files[0];
          if (signatureFile) {
            formData.append("signature", signatureFile);
          }

          try {
            const response = await fetch(
              `/api/drivers/${DRIVER_ID}/deliveries/${packageId}/proof`,
              {
                method: "POST",
                body: formData,
              }
            );

            const data = await response.json();
            if (data.ok) {
              alert("Proof of delivery uploaded successfully!");
              document.getElementById("proofForm").reset();
              addUpdateToList(
                `Proof uploaded for package ${packageId}`,
                "medium"
              );
            } else {
              alert("Failed to upload proof: " + data.error);
            }
          } catch (error) {
            console.error("Failed to upload proof:", error);
            alert("Failed to upload proof");
          }
        });

      // Update connection status indicator
      function updateConnectionStatus(connected) {
        const status = document.getElementById("connectionStatus");
        if (connected) {
          status.textContent = "üü¢ Connected";
          status.className = "connection-status connected";
        } else {
          status.textContent = "üî¥ Disconnected";
          status.className = "connection-status disconnected";
        }
      }

      // Simulate location updates (in production, this would use GPS)
      setInterval(() => {
        if (socket.connected) {
          socket.emit("location-update", {
            driverId: DRIVER_ID,
            latitude: 6.9271 + (Math.random() - 0.5) * 0.01,
            longitude: 79.8612 + (Math.random() - 0.5) * 0.01,
          });
        }
      }, 30000); // Update location every 30 seconds

      // Auto-refresh route updates
      setInterval(loadRouteUpdates, 60000); // Check for updates every minute
    </script>
  </body>
</html>
